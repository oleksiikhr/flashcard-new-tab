"use strict";(()=>{var c=(e,t,n)=>new Promise((r,i)=>{var o=d=>{try{a(n.next(d))}catch(m){i(m)}},s=d=>{try{a(n.throw(d))}catch(m){i(m)}},a=d=>d.done?r(d.value):Promise.resolve(d.value).then(o,s);a((n=n.apply(e,t)).next())});var f=class{constructor(t){this.type=t}getType(){return this.type}getColor(){return this.getType()===1?"dark":"light"}};function B(){return window.matchMedia("(prefers-color-scheme:dark)").matches}function j(e){return e!==null&&typeof e=="object"&&!Array.isArray(e)}function N(e){return Array.isArray(e)?e:[e]}var O=e=>{let t=localStorage.getItem(e);if(t===null)return null;let n;try{n=JSON.parse(t)}catch(r){return console.warn(r),null}return j(n)?n:(console.warn(`This "${e}" key is not an object`),null)},H=(e,t)=>{localStorage.setItem(e,JSON.stringify(t))};var M=e=>({type:e.getType()}),F=e=>new f(e.type);var K=()=>{let e=O("theme");return e===null?null:F(e)};var z=()=>{let e=K();return e!==null?e:B()?new f(1):new f(0)};var V=e=>{H("theme",M(e))};var G=e=>{let t=new f(e);return V(t),t};var D=null,k=z(),R=()=>{var e;(e=document.documentElement)==null||e.setAttribute("data-theme",k.getColor()),D==null||D.setAttribute("aria-label",k.getColor())},U=()=>{D=document.querySelector('[component="theme-toggle"]'),D==null||D.addEventListener("click",()=>{k=G(1===k.getType()?0:1),R()}),R(),window.removeEventListener("DOMContentLoaded",U)},W={register(){R(),window.addEventListener("DOMContentLoaded",U)}};var $="2.2.0";function g(e,t={},...n){let r=document.createElement(e);return Object.entries(t).forEach(([i,o])=>{typeof o=="string"?r.setAttribute(i,o):r.addEventListener(i,o)}),n.forEach(i=>{r.append(i)}),r}var Q=(e,t)=>{let n=document.querySelector('[component="feed-statistics"]');n.innerText="",n.append(g("div",{class:"feed-statistics__position"},e.toString()),g("div",{class:"feed-statistics__count"},`/${t.toString()}`))};var C=class{constructor(t,n,r,i,o,s,a,d,m,x){this.id=t;this.deckId=n;this.question=r;this.content=i;this.templateType=o;this.statistics=s;this.isActive=a;this.seenAt=d;this.updatedAt=m;this.createdAt=x;this.initIsActive=this.isActive}static create(t,n,r,i,o=!0){return new C(void 0,t,n,r,i,{views:0,clicks:0},o,new Date,new Date,new Date)}update(t,n,r){this.question=t,this.content=n,this.isActive=r,this.updatedAt=new Date}isExists(){return this.id!==void 0}setId(t){if(this.isExists())throw new Error("ID is already exists");this.id=t}getId(){if(this.id===void 0)throw new Error("The ID already exists");return this.id}getDeckId(){return this.deckId}getQuestion(){return this.question}getContent(){return this.content}getTemplateType(){return this.templateType}getStatistics(){return this.statistics}getIsActive(){return this.isActive}isActiveChanged(){return this.isActive!==this.initIsActive}getSeenAt(){return this.seenAt}getUpdatedAt(){return this.updatedAt}getCreatedAt(){return this.createdAt}updateLastSeen(){this.statistics.views+=1,this.seenAt=new Date}};function S(e,t,n=100){let r=()=>{let i=+e.innerText,o=t/n;i<t?(e.innerText=Math.ceil(i+o).toString(),setTimeout(r,1)):e.innerText=t.toString()};r()}var Y=(e,t)=>{let n=t.getContent();e.append(g("div",{class:"card-vocabulary-question"},t.getQuestion()));let r=g("div",{class:"card-vocabulary-helper"},"Show answer");r.innerText=n.getAnswer(),r.classList.add("card-vocabulary-helper_clicked"),e.append(r)};var J=(e,t,n)=>{let r=document.querySelector('[component="card"]');r.querySelector(".card-deck-name").innerText=t.getName(),S(r.querySelector(".card-clicks-value"),e.getStatistics().clicks),S(r.querySelector(".card-views-value"),e.getStatistics().views);let i=document.querySelector(".card-tag-values");i.innerText="",n.forEach(s=>{i.append(g("span",{class:"card-tag-value"},s.getName()))});let o=r.querySelector(".card__content");o.innerText="",e.getTemplateType()===0&&(r.classList.add("card_vocabulary"),Y(o,e))};var v=class{constructor(t,n,r,i,o){this.card=t;this.deck=n;this.tags=r;this.count=i;this.position=o}getCard(){return this.card}getDeck(){return this.deck}getTags(){return this.tags}getCount(){return this.count}getPosition(){return this.position}};function Ie(e){return e.sort(()=>Math.random()-.5)}function Ee(e,t="asc"){return t==="asc"?e.sort((n,r)=>n-r):e.sort((n,r)=>r-n)}function X(e,t,n=0){let r=[...Array(e).keys()].map(i=>i+n);return Ie(r),Ee(r.slice(0,t))}function Z(e,t){return Math.floor(Math.random()*(t-e+1))+e}var ee=e=>{let t=e.answer||"";return{getAnswer:()=>t,serialize:()=>({answer:t})}};var te=(e,t)=>{if(t===0)return ee(e);throw new Error("Content not supported by template type.")};var re=e=>({id:e.isExists()?e.getId():void 0,deck_id:e.getDeckId(),question:e.getQuestion(),content:e.getContent().serialize(),template_type:e.getTemplateType(),statistics:e.getStatistics(),is_active:+e.getIsActive(),seen_at:e.getSeenAt(),updated_at:e.getUpdatedAt(),created_at:e.getCreatedAt()}),w=e=>new C(e.id!==void 0?e.id:void 0,e.deck_id,e.question,te(e.content,e.template_type),e.template_type,e.statistics,!!e.is_active,e.seen_at,e.updated_at,e.created_at);var T=class{constructor(t,n,r,i,o,s,a,d,m,x){this.id=t;this.name=n;this.isActive=r;this.cardsCount=i;this.activeCardsCount=o;this.tagsCount=s;this.settings=a;this.generateAt=d;this.updatedAt=m;this.createdAt=x}static create(t,n,r){return new T(void 0,t,n,0,0,0,r,new Date,new Date,new Date)}update(t,n,r){this.name=t,this.isActive=n,this.settings=r,this.updatedAt=new Date}isExists(){return this.id!==void 0}setId(t){if(this.isExists())throw new Error("ID is already exists");this.id=t}getId(){if(this.id===void 0)throw new Error("The ID already exists");return this.id}getName(){return this.name}getIsActive(){return this.isActive}getCardsCount(){return this.cardsCount}getActiveCardsCount(){return this.activeCardsCount}getTagsCount(){return this.tagsCount}getSettings(){return this.settings}nextGenerateAt(){let t=new Date;t.setHours(t.getHours()+this.settings.recalculate.hours),this.generateAt=t}getGeneratedAt(){return this.generateAt}getUpdatedAt(){return this.updatedAt}getCreatedAt(){return this.createdAt}};var ne=e=>({id:e.isExists()?e.getId():void 0,name:e.getName(),is_active:+e.getIsActive(),cards_count:e.getCardsCount(),active_cards_count:e.getActiveCardsCount(),tags_count:e.getTagsCount(),settings:e.getSettings(),generate_at:e.getGeneratedAt(),updated_at:e.getUpdatedAt(),created_at:e.getCreatedAt()}),_=e=>new T(e.id,e.name,!!e.is_active,e.cards_count,e.active_cards_count,e.tags_count,e.settings,e.generate_at,e.updated_at,e.created_at);var ie=(e,t)=>new Promise((n,r)=>{let i=indexedDB.open(e,t.length);i.onupgradeneeded=o=>{let s=t[o.oldVersion];if(s===void 0)throw new Error(`Migration not found: v${o.oldVersion}`);s(o).catch(console.error)},i.onsuccess=o=>{let s=o.target.result;n(s)},i.onerror=r}),u=e=>new Promise((t,n)=>{e.onsuccess=r=>{let i=r.target.result;try{t(i)}catch(o){n(o)}},e.onerror=r=>n(r)});var oe=(e,t)=>new Promise((n,r)=>{let i=!0;e.onsuccess=o=>{let s=o.target.result;i&&t!==0?(i=!1,s.advance(t)):n(s.value)},e.onerror=r}),se=(e,t)=>new Promise((n,r)=>{e.onsuccess=i=>{let o=i.target.result;if(!o){n();return}try{if(t(o.primaryKey)===!1){n();return}o.continue()}catch(s){r(s)}},e.onerror=r}),ae=(e,t)=>new Promise((n,r)=>{e.onsuccess=i=>{let o=i.target.result;if(!o){n();return}try{t(o)===!1&&n()}catch(s){r(s)}},e.onerror=r});var ce="flashcard-new-tab";var de=e=>new Promise((t,n)=>{let r=e.target.result;r.onerror=n,r.createObjectStore("decks",{keyPath:"id",autoIncrement:!0}).createIndex("generate_at_idx","generate_at");let o=r.createObjectStore("cards",{keyPath:"id",autoIncrement:!0});o.createIndex("deck_id_and_is_active_idx",["deck_id","is_active"]),o.createIndex("question_idx","question");let s=r.createObjectStore("tags",{keyPath:"id",autoIncrement:!0});s.createIndex("deck_id_idx","deck_id"),s.createIndex("deck_id_and_name_idx",["deck_id","name"],{unique:!0});let a=r.createObjectStore("card_tag",{keyPath:["card_id","tag_id"]});a.createIndex("card_id_idx","card_id"),a.createIndex("tag_id_idx","tag_id"),a.createIndex("deck_id_idx","deck_id"),r.createObjectStore("feed",{keyPath:"card_id"}).createIndex("deck_id_idx","deck_id");let m=r.createObjectStore("statistics",{keyPath:"id",autoIncrement:!0});m.createIndex("deck_id_idx","deck_id"),m.createIndex("card_id_idx","card_id"),t()});var ue=[de];var I=null,p=()=>I!=null?I:I=ie(ce,ue);var E=(e,t)=>c(void 0,null,function*(){let r=(yield p()).transaction("tags","readonly").objectStore("tags").index("deck_id_and_name_idx").get(IDBKeyRange.only([e,t]));return u(r).then(i=>i!==void 0?A(i):void 0)});var y=class{constructor(t,n,r,i,o){this.id=t;this.deckId=n;this.name=r;this.updatedAt=i;this.createdAt=o}static create(t,n){return c(this,null,function*(){let r=new y(void 0,t,n,new Date,new Date);if((yield E(t,n))!==null)throw new Error("Tag name with this deck must be unique.");return r})}update(t){return c(this,null,function*(){if(t!==this.name&&(yield E(this.deckId,t))!==null)throw new Error("Tag name with this deck must be unique.");this.name=t,this.updatedAt=new Date})}isExists(){return this.id!==void 0}setId(t){if(this.isExists())throw new Error("ID is already exists");this.id=t}getId(){if(this.id===void 0)throw new Error("The ID already exists");return this.id}getDeckId(){return this.deckId}getName(){return this.name}getUpdatedAt(){return this.updatedAt}getCreatedAt(){return this.createdAt}};var A=e=>new y(e.id,e.deck_id,e.name,e.updated_at,e.created_at);var me=()=>c(void 0,null,function*(){let t=(yield p()).transaction(["decks","feed","cards","card_tag","tags"],"readonly"),n=t.objectStore("feed"),r=t.objectStore("cards"),i=t.objectStore("tags"),o=t.objectStore("decks"),s=t.objectStore("card_tag").index("card_id_idx"),a=yield u(n.count());if(a===0)return;let d=Z(0,a-1),m=yield oe(n.openCursor(),d);if(m===void 0)return;let[x,P,we]=yield Promise.all([u(r.get(m.card_id)).then(l=>l!==void 0?w(l):void 0),u(o.get(m.deck_id)).then(l=>l!==void 0?_(l):void 0),u(s.getAll(m.card_id)).then(l=>Promise.all(l.map(_e=>u(i.get(_e.tag_id)).then(L=>L!==void 0?A(L):void 0))))]);if(x===void 0)throw new Error("Card not found.");if(P===void 0)throw new Error("Deck not found.");return new v(x,P,we.filter(l=>l!==void 0),a,d+1)});var b=(e,t,n)=>c(void 0,null,function*(){let r=new Set,i=n.filter(a=>{let d=a.isNeedHandle(t);return d&&r.add(a.getStoreName(t)),d}),o=e.transaction(r,"readwrite"),s=[];try{i.forEach(a=>{let d=a.invoke(o,t);s.push(...N(d))})}catch(a){return o.abort(),Promise.all(s).catch(()=>{}),Promise.reject(a)}return Promise.all(s).then(()=>o.commit()).catch(a=>{throw o.abort(),a})});var pe={isNeedHandle(){return!0},getStoreName(){return"cards"},invoke(e,t){let r=e.objectStore("cards").put(re(t));return u(r)}};var le={isNeedHandle(e){return e.isActiveChanged()},getStoreName(){return"decks"},invoke(e,t){return c(this,null,function*(){let n=e.objectStore("decks"),r=n.get(t.getDeckId()),i=yield u(r);return i===void 0?Promise.resolve(void 0):(t.isActiveChanged()&&(i.active_cards_count+=t.getIsActive()?1:-1),u(n.put(i)))})}};var fe=e=>c(void 0,null,function*(){let t=yield p();return b(t,e,[pe,le])});var ge=()=>{document.body.querySelector(".package-version").innerText=`Version ${$}`,me().then(e=>{e!==void 0&&(e.getCard().updateLastSeen(),fe(e.getCard()).catch(console.error),Q(e.getPosition(),e.getCount()),J(e.getCard(),e.getDeck(),e.getTags()))}).catch(e=>console.error(e)).finally(()=>{document.body.style.display=""})};var he=e=>c(void 0,null,function*(){let n=(yield p()).transaction("decks").objectStore("decks").index("generate_at_idx").getAll(IDBKeyRange.upperBound(new Date),e);return u(n).then(r=>r.map(i=>_(i)))});var be=(e,t)=>c(void 0,null,function*(){let r=(yield p()).transaction("cards","readonly").objectStore("cards").index("deck_id_and_is_active_idx"),i=IDBKeyRange.only([e,1]),o=yield u(r.count(i)),s=X(o,t,1),a=[],d=!0;return yield ae(r.openCursor(i),m=>{let x=w(m.value);return d&&s[0]!==1?(d=!1,m.advance(s[0]-1)):a.push(x)===s.length?!1:m.advance(s[a.length]-s[a.length-1])}),a});var De={isNeedHandle(){return!0},getStoreName(){return"decks"},invoke(e,t){let n=ne(t),i=e.objectStore("decks").put(n);return u(i)}};var q=e=>c(void 0,null,function*(){let t=yield p();return b(t,e,[De])});var Ce={isNeedHandle(){return!0},getStoreName(){return"feed"},invoke(e,t){let n=e.objectStore("feed"),r=n.index("deck_id_idx").openKeyCursor(t.getId());return se(r,i=>{n.delete(i)})}};var Te=e=>c(void 0,null,function*(){let t=yield p();return b(t,e,[Ce])});var ye={isNeedHandle(){return!0},getStoreName(){return"feed"},invoke(e,t){return c(this,null,function*(){let r=e.objectStore("feed").add({card_id:t.getId(),deck_id:t.getDeckId()});return u(r)})}};var xe=e=>c(void 0,null,function*(){let t=yield p();return b(t,e,[ye])});var ve=e=>(e.nextGenerateAt(),!e.getIsActive()||!e.getActiveCardsCount()?q(e).then(()=>({deck:e,cards:[]})):be(e.getId(),e.getSettings().recalculate.count).then(t=>Te(e).then(()=>t)).then(t=>Promise.all(t.map(n=>xe(n))).then(()=>t)).then(t=>q(e).then(()=>({deck:e,cards:t}))));var ke=(e,t)=>c(void 0,null,function*(){let r=(yield he(e)).map(i=>ve(i).then(o=>(t!==void 0&&t(i),o)));return Promise.all(r)});W.register();window.addEventListener("DOMContentLoaded",()=>{ge()});setTimeout(()=>{var e;(e=navigator.serviceWorker)==null||e.getRegistrations().then(t=>{let n=t.map(r=>r.unregister());Promise.all(n).catch(r=>console.error(r))}).catch(t=>console.error(t)),ke(3).then(t=>console.log(t)).catch(t=>console.error(t))},1500);})();
