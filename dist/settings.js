"use strict";(()=>{var a=(e,t,n)=>new Promise((r,o)=>{var i=d=>{try{c(n.next(d))}catch(m){o(m)}},s=d=>{try{c(n.throw(d))}catch(m){o(m)}},c=d=>d.done?r(d.value):Promise.resolve(d.value).then(i,s);c((n=n.apply(e,t)).next())});var b=class{constructor(t){this.type=t}getType(){return this.type}getColor(){return this.getType()===1?"dark":"light"}};function j(){return window.matchMedia("(prefers-color-scheme:dark)").matches}function K(e){return e!==null&&typeof e=="object"&&!Array.isArray(e)}function H(e){return Array.isArray(e)?e:[e]}var F=e=>{let t=localStorage.getItem(e);if(t===null)return null;let n;try{n=JSON.parse(t)}catch(r){return console.warn(r),null}return K(n)?n:(console.warn(`This "${e}" key is not an object`),null)},z=(e,t)=>{localStorage.setItem(e,JSON.stringify(t))};var G=e=>({type:e.getType()}),M=e=>new b(e.type);var V=()=>{let e=F("theme");return e===null?null:M(e)};var U=()=>{let e=V();return e!==null?e:j()?new b(1):new b(0)};var $=e=>{z("theme",G(e))};var W=e=>{let t=new b(e);return $(t),t};var x=null,I=U(),L=()=>{var e;(e=document.documentElement)==null||e.setAttribute("data-theme",I.getColor()),x==null||x.setAttribute("aria-label",I.getColor())},Q=()=>{x=document.querySelector('[component="theme-toggle"]'),x==null||x.addEventListener("click",()=>{I=W(1===I.getType()?0:1),L()}),L(),window.removeEventListener("DOMContentLoaded",Q)},Y={register(){L(),window.addEventListener("DOMContentLoaded",Q)}};function u(e,t={},...n){let r=document.createElement(e);return Object.entries(t).forEach(([o,i])=>{typeof i=="string"?r.setAttribute(o,i):r.addEventListener(o,i)}),n.forEach(o=>{r.append(o)}),r}function E(e){return e.sort(()=>Math.random()-.5)}function He(e,t="asc"){return t==="asc"?e.sort((n,r)=>n-r):e.sort((n,r)=>r-n)}function J(e,t,n=0){let r=[...Array(e).keys()].map(o=>o+n);return E(r),He(r.slice(0,t))}var k=class{constructor(t,n,r,o,i,s,c,d,m,l){this.id=t;this.deckId=n;this.question=r;this.content=o;this.templateType=i;this.statistics=s;this.isActive=c;this.seenAt=d;this.updatedAt=m;this.createdAt=l;this.initIsActive=this.isActive}static create(t,n,r,o,i=!0){return new k(void 0,t,n,r,o,{views:0,clicks:0},i,new Date,new Date,new Date)}update(t,n,r){this.question=t,this.content=n,this.isActive=r,this.updatedAt=new Date}isExists(){return this.id!==void 0}setId(t){if(this.isExists())throw new Error("ID is already exists");this.id=t}getId(){if(this.id===void 0)throw new Error("The ID already exists");return this.id}getDeckId(){return this.deckId}getQuestion(){return this.question}getContent(){return this.content}getTemplateType(){return this.templateType}getStatistics(){return this.statistics}getIsActive(){return this.isActive}isActiveChanged(){return this.isActive!==this.initIsActive}getSeenAt(){return this.seenAt}getUpdatedAt(){return this.updatedAt}getCreatedAt(){return this.createdAt}updateLastSeen(){this.statistics.views+=1,this.seenAt=new Date}};var X=e=>({id:e.isExists()?e.getId():void 0,deck_id:e.getDeckId(),name:e.getName(),updated_at:e.getUpdatedAt(),created_at:e.getCreatedAt()}),Z=e=>new w(e.id,e.deck_id,e.name,e.updated_at,e.created_at);var ee=(e,t)=>new Promise((n,r)=>{let o=indexedDB.open(e,t.length);o.onupgradeneeded=i=>{let s=t[i.oldVersion];if(s===void 0)throw new Error(`Migration not found: v${i.oldVersion}`);s(i).catch(console.error)},o.onsuccess=i=>{let s=i.target.result;n(s)},o.onerror=r}),p=e=>new Promise((t,n)=>{e.onsuccess=r=>{let o=r.target.result;try{t(o)}catch(i){n(i)}},e.onerror=r=>n(r)}),te=(e,t)=>{let n=[];return new Promise(r=>{e.onsuccess=o=>{let i=o.target.result;if(!i){r(n);return}n.push(i.value),n.length<t?i.continue():r(n)}})};var T=(e,t)=>new Promise((n,r)=>{e.onsuccess=o=>{let i=o.target.result;if(!i){n();return}try{if(t(i.primaryKey)===!1){n();return}i.continue()}catch(s){r(s)}},e.onerror=r}),re=(e,t)=>new Promise((n,r)=>{e.onsuccess=o=>{let i=o.target.result;if(!i){n();return}try{t(i)===!1&&n()}catch(s){r(s)}},e.onerror=r});var ne="flashcard-new-tab";var oe=e=>new Promise((t,n)=>{let r=e.target.result;r.onerror=n,r.createObjectStore("decks",{keyPath:"id",autoIncrement:!0}).createIndex("generate_at_idx","generate_at");let i=r.createObjectStore("cards",{keyPath:"id",autoIncrement:!0});i.createIndex("deck_id_and_is_active_idx",["deck_id","is_active"]),i.createIndex("question_idx","question");let s=r.createObjectStore("tags",{keyPath:"id",autoIncrement:!0});s.createIndex("deck_id_idx","deck_id"),s.createIndex("deck_id_and_name_idx",["deck_id","name"],{unique:!0});let c=r.createObjectStore("card_tag",{keyPath:["card_id","tag_id"]});c.createIndex("card_id_idx","card_id"),c.createIndex("tag_id_idx","tag_id"),c.createIndex("deck_id_idx","deck_id"),r.createObjectStore("feed",{keyPath:"card_id"}).createIndex("deck_id_idx","deck_id");let m=r.createObjectStore("statistics",{keyPath:"id",autoIncrement:!0});m.createIndex("deck_id_idx","deck_id"),m.createIndex("card_id_idx","card_id"),t()});var ie=[oe];var N=null,f=()=>N!=null?N:N=ee(ne,ie);var v=(e,t)=>a(void 0,null,function*(){let r=(yield f()).transaction("tags","readonly").objectStore("tags").index("deck_id_and_name_idx").get(IDBKeyRange.only([e,t]));return p(r).then(o=>o!==void 0?Z(o):void 0)});var w=class{constructor(t,n,r,o,i){this.id=t;this.deckId=n;this.name=r;this.updatedAt=o;this.createdAt=i}static create(t,n){return a(this,null,function*(){let r=new w(void 0,t,n,new Date,new Date);if((yield v(t,n))!==null)throw new Error("Tag name with this deck must be unique.");return r})}update(t){return a(this,null,function*(){if(t!==this.name&&(yield v(this.deckId,t))!==null)throw new Error("Tag name with this deck must be unique.");this.name=t,this.updatedAt=new Date})}isExists(){return this.id!==void 0}setId(t){if(this.isExists())throw new Error("ID is already exists");this.id=t}getId(){if(this.id===void 0)throw new Error("The ID already exists");return this.id}getDeckId(){return this.deckId}getName(){return this.name}getUpdatedAt(){return this.updatedAt}getCreatedAt(){return this.createdAt}};var ae=e=>{let t=e.answer||"";return{getAnswer:()=>t,serialize:()=>({answer:t})}};var R=(e,t)=>{if(t===0)return ae(e);throw new Error("Content not supported by template type.")};var _=e=>({id:e.isExists()?e.getId():void 0,deck_id:e.getDeckId(),question:e.getQuestion(),content:e.getContent().serialize(),template_type:e.getTemplateType(),statistics:e.getStatistics(),is_active:+e.getIsActive(),seen_at:e.getSeenAt(),updated_at:e.getUpdatedAt(),created_at:e.getCreatedAt()}),A=e=>new k(e.id!==void 0?e.id:void 0,e.deck_id,e.question,R(e.content,e.template_type),e.template_type,e.statistics,!!e.is_active,e.seen_at,e.updated_at,e.created_at);var se=e=>a(void 0,null,function*(){let n=(yield f()).transaction("cards","readonly").objectStore("cards").index("question_idx").get(e);return p(n).then(r=>r!==void 0?A(r):void 0)});var C=(e,t,n)=>a(void 0,null,function*(){let r=new Set,o=n.filter(c=>{let d=c.isNeedHandle(t);return d&&r.add(c.getStoreName(t)),d}),i=e.transaction(r,"readwrite"),s=[];try{o.forEach(c=>{let d=c.invoke(i,t);s.push(...H(d))})}catch(c){return i.abort(),Promise.all(s).catch(()=>{}),Promise.reject(c)}return Promise.all(s).then(()=>i.commit()).catch(c=>{throw i.abort(),c})});var ce={isNeedHandle(){return!0},getStoreName(){return"cards"},invoke(e,t){let n=_(t);delete n.id;let o=e.objectStore("cards").add(n);return p(o).then(i=>{t.setId(i)})}};var de={isNeedHandle(){return!0},getStoreName(){return"decks"},invoke(e,t){return a(this,null,function*(){let n=e.objectStore("decks"),r=n.get(t.getDeckId()),o=yield p(r);return o===void 0?Promise.resolve(void 0):(o.cards_count+=1,t.getIsActive()&&(o.active_cards_count+=1),p(n.put(o)))})}};var me=e=>a(void 0,null,function*(){let t=yield f();return C(t,e,[ce,de])});var ue={isNeedHandle(){return!0},getStoreName(){return"cards"},invoke(e,t){let r=e.objectStore("cards").put(_(t));return p(r)}};var pe={isNeedHandle(e){return e.isActiveChanged()},getStoreName(){return"decks"},invoke(e,t){return a(this,null,function*(){let n=e.objectStore("decks"),r=n.get(t.getDeckId()),o=yield p(r);return o===void 0?Promise.resolve(void 0):(t.isActiveChanged()&&(o.active_cards_count+=t.getIsActive()?1:-1),p(n.put(o)))})}};var le=e=>a(void 0,null,function*(){let t=yield f();return C(t,e,[ue,pe])});var fe={isNeedHandle(){return!0},getStoreName(){return"card_tag"},invoke(r,o){return a(this,arguments,function*(e,{card:t,tags:n}){let i=e.objectStore("card_tag"),s=i.index("card_id_idx").openKeyCursor(t.getId());return yield T(s,c=>{i.delete(c)}),Promise.all(n.map(c=>i.add({card_id:t.getId(),deck_id:t.getDeckId(),tag_id:c.getId()})))})}};var ge=(e,t)=>a(void 0,null,function*(){let n=yield f();return C(n,{card:e,tags:t},[fe])});var De={isNeedHandle(){return!0},getStoreName(){return"tags"},invoke(e,t){let n=X(t);delete n.id;let o=e.objectStore("tags").add(n);return p(o).then(i=>{t.setId(i)})}};var Ce={isNeedHandle(){return!0},getStoreName(){return"decks"},invoke(e,t){return a(this,null,function*(){let n=e.objectStore("decks"),r=n.get(t.getDeckId()),o=yield p(r);return o===void 0?Promise.resolve(void 0):(o.tags_count+=1,p(n.put(o)))})}};var Te=e=>a(void 0,null,function*(){let t=yield f();return C(t,e,[De,Ce])});var y=class{constructor(t,n,r,o,i,s,c,d,m,l){this.id=t;this.name=n;this.isActive=r;this.cardsCount=o;this.activeCardsCount=i;this.tagsCount=s;this.settings=c;this.generateAt=d;this.updatedAt=m;this.createdAt=l}static create(t,n,r){return new y(void 0,t,n,0,0,0,r,new Date,new Date,new Date)}update(t,n,r){this.name=t,this.isActive=n,this.settings=r,this.updatedAt=new Date}isExists(){return this.id!==void 0}setId(t){if(this.isExists())throw new Error("ID is already exists");this.id=t}getId(){if(this.id===void 0)throw new Error("The ID already exists");return this.id}getName(){return this.name}getIsActive(){return this.isActive}getCardsCount(){return this.cardsCount}getActiveCardsCount(){return this.activeCardsCount}getTagsCount(){return this.tagsCount}getSettings(){return this.settings}nextGenerateAt(){let t=new Date;t.setHours(t.getHours()+this.settings.recalculate.hours),this.generateAt=t}getGeneratedAt(){return this.generateAt}getUpdatedAt(){return this.updatedAt}getCreatedAt(){return this.createdAt}};var q=e=>({id:e.isExists()?e.getId():void 0,name:e.getName(),is_active:+e.getIsActive(),cards_count:e.getCardsCount(),active_cards_count:e.getActiveCardsCount(),tags_count:e.getTagsCount(),settings:e.getSettings(),generate_at:e.getGeneratedAt(),updated_at:e.getUpdatedAt(),created_at:e.getCreatedAt()}),P=e=>new y(e.id,e.name,!!e.is_active,e.cards_count,e.active_cards_count,e.tags_count,e.settings,e.generate_at,e.updated_at,e.created_at);var S=e=>a(void 0,null,function*(){let n=(yield f()).transaction("decks").objectStore("decks").get(e);return p(n).then(r=>r!==void 0?P(r):void 0)});var ze=(e,t)=>a(void 0,null,function*(){let n=new Set;t.forEach(s=>{(s.tags||[]).forEach(c=>{n.add(c)})});let r=[];n.forEach(s=>{let c=v(e,s).then(d=>a(void 0,null,function*(){if(d!==void 0)return Promise.resolve(d);let m=yield w.create(e,s);return Te(m).then(()=>m)}));r.push(c)});let o=yield Promise.all(r),i=new Map;return o.forEach(s=>{i.set(s.getName(),s)}),i}),B=(e,t,n)=>a(void 0,null,function*(){let r=yield S(e);if(r===void 0)throw new Error("Deck not found.");let o=yield ze(r.getId(),t),i=t.map(s=>{let{question:c}=s,d=R(s.content,0),m=(s.tags||[]).map(l=>o.get(l));return se(c).then(l=>{var D;if(l===void 0){let h=k.create(e,c,d,0,s.is_active);return me(h).then(()=>h)}return l.update(c,d,(D=s.is_active)!=null?D:l.getIsActive()),le(l).then(()=>l)}).then(l=>m.length?ge(l,m).then(()=>l):Promise.resolve(l)).then(l=>(n!==void 0&&n(l),l))});return Promise.all(i)});var he=(e,t)=>a(void 0,null,function*(){let r=(yield f()).transaction("decks").objectStore("decks").openCursor(e!==void 0?IDBKeyRange.lowerBound(e):null);return te(r,t).then(o=>o.map(i=>P(i)))});var be={isNeedHandle(){return!0},getStoreName(){return"cards"},invoke(e,t){let n=e.objectStore("cards"),r=n.index("deck_id_and_is_active_idx");return Promise.all([T(r.openKeyCursor(IDBKeyRange.only([t.getId(),0])),o=>{n.delete(o)}),T(r.openKeyCursor(IDBKeyRange.only([t.getId(),1])),o=>{n.delete(o)})])}};var ke={isNeedHandle(){return!0},getStoreName(){return"card_tag"},invoke(e,t){let n=e.objectStore("card_tag"),r=n.index("deck_id_idx").openKeyCursor(t.getId());return T(r,o=>{n.delete(o)})}};var we={isNeedHandle(){return!0},getStoreName(){return"tags"},invoke(e,t){let n=e.objectStore("tags"),r=n.index("deck_id_idx").openKeyCursor(t.getId());return T(r,o=>{n.delete(o)})}};var ye={isNeedHandle(){return!0},getStoreName(){return"decks"},invoke(e,t){let r=e.objectStore("decks").delete(t.getId());return p(r)}};var xe={isNeedHandle(){return!0},getStoreName(){return"feed"},invoke(e,t){let n=e.objectStore("feed"),r=n.index("deck_id_idx").openKeyCursor(t.getId());return T(r,o=>{n.delete(o)})}};var Se=e=>a(void 0,null,function*(){let t=yield f();return C(t,e,[be,xe,we,ke,ye])});var ve=e=>a(void 0,null,function*(){let t=yield S(e);t!==void 0&&(yield Se(t))});var Ie={isNeedHandle(){return!0},getStoreName(){return"decks"},invoke(e,t){let n=q(t);delete n.id;let o=e.objectStore("decks").add(n);return p(o).then(i=>{t.setId(i)})}};var Re=e=>a(void 0,null,function*(){let t=yield f();return C(t,e,[Ie])});var _e=(e,t,n)=>a(void 0,null,function*(){let r=y.create(e,t,n);return yield Re(r),r});var Ae=(e,t)=>a(void 0,null,function*(){let r=(yield f()).transaction("cards","readonly").objectStore("cards").index("deck_id_and_is_active_idx"),o=IDBKeyRange.only([e,1]),i=yield p(r.count(o)),s=J(i,t,1),c=[],d=!0;return yield re(r.openCursor(o),m=>{let l=A(m.value);return d&&s[0]!==1?(d=!1,m.advance(s[0]-1)):c.push(l)===s.length?!1:m.advance(s[c.length]-s[c.length-1])}),c});var qe={isNeedHandle(){return!0},getStoreName(){return"decks"},invoke(e,t){let n=q(t),o=e.objectStore("decks").put(n);return p(o)}};var O=e=>a(void 0,null,function*(){let t=yield f();return C(t,e,[qe])});var Pe={isNeedHandle(){return!0},getStoreName(){return"feed"},invoke(e,t){let n=e.objectStore("feed"),r=n.index("deck_id_idx").openKeyCursor(t.getId());return T(r,o=>{n.delete(o)})}};var Le=e=>a(void 0,null,function*(){let t=yield f();return C(t,e,[Pe])});var Ee={isNeedHandle(){return!0},getStoreName(){return"feed"},invoke(e,t){return a(this,null,function*(){let r=e.objectStore("feed").add({card_id:t.getId(),deck_id:t.getDeckId()});return p(r)})}};var Ne=e=>a(void 0,null,function*(){let t=yield f();return C(t,e,[Ee])});var Be=e=>(e.nextGenerateAt(),!e.getIsActive()||!e.getActiveCardsCount()?O(e).then(()=>({deck:e,cards:[]})):Ae(e.getId(),e.getSettings().recalculate.count).then(t=>Le(e).then(()=>t)).then(t=>Promise.all(t.map(n=>Ne(n))).then(()=>t)).then(t=>O(e).then(()=>({deck:e,cards:t}))));var Oe=e=>a(void 0,null,function*(){let t=yield S(e);if(t===void 0)throw new Error("Deck not found");return Be(t)});var je=()=>{var s,c;let e=document.querySelector('[page="settings"]'),t=e.querySelector("#decks-list"),n=e.querySelector("#process");function r(d){n.innerText=d}let o=(d,m)=>a(void 0,null,function*(){r("Downloading the file..");let l=yield fetch("https://raw.githubusercontent.com/oleksiikhr/flashcard-new-tab/storage/storage/eng-ukr.json").then(h=>h.json());r("Preparing data.."),m!==null&&(E(l),l=l.slice(0,m));let D=0;return B(d,l,()=>{D+=1,r(`Importing: ${D}`)}).then(()=>{r("Cards imported")}).catch(h=>{r("Something went wrong"),console.error(h)})}),i=()=>{he(void 0,10).then(d=>{t.innerText="",d.forEach(m=>{let{recalculate:l}=m.getSettings();t.append(u("div",{style:"display: inline-block; border: 1px solid; padding: 15px; font-size: 1.5em; text-align: left; margin: 10px;"},u("div",{},u("strong",{},"ID: "),u("span",{},m.getId().toString())),u("div",{},u("strong",{},"Name: "),u("span",{},m.getName())),u("div",{},u("strong",{},"Cards/Active: "),u("span",{},`${m.getCardsCount()}/${m.getActiveCardsCount()}`)),u("div",{},u("strong",{},"Next generate feed: "),u("span",{},m.getGeneratedAt().toLocaleString())),u("div",{},u("strong",{},"Settings: "),u("span",{},`Recalculate Feed (hours: ${l.hours}, count: ${l.count})`)),u("br"),u("div",{style:"font-weight: bold; text-align: center;"},"Action"),u("br"),u("button",{click:()=>{ve(m.getId()).then(()=>{r("Deck deleted"),i()}).catch(D=>{r("Something went wrong"),console.error(D)})}},"Delete Deck"),u("button",{click:()=>{Oe(m.getId()).then(()=>{r("Feed regenerated")}).catch(D=>{r("Something went wrong"),console.error(D)})}},"Generate Feed"),u("br"),u("br"),u("div",{style:"font-weight: bold; text-align: center;"},"Import Cards"),u("br"),u("button",{click:()=>{o(m.getId(),10).catch(D=>{console.error(D)})}},"Random 10"),u("button",{click:()=>{o(m.getId(),1e3).catch(D=>{console.error(D)})}},"Random 1000"),u("button",{click:()=>{o(m.getId()).catch(D=>{console.error(D)})}},"All (~73k)"),u("br"),u("div",{},"")))})}).catch(d=>{console.error(d)})};(s=e.querySelector("#create-deck-button"))==null||s.addEventListener("click",()=>{_e("Eng - Ukr",!0,{recalculate:{hours:24,count:50,algorithm:"random"}}).then(()=>{r("Deck created"),i()}).catch(d=>{r("Something went wrong"),console.error(d)})}),(c=e.querySelector("#import"))==null||c.addEventListener("click",()=>{let{files:d}=e.querySelector("#file");if(d===null||d.length===0)return;let m=new FileReader;m.onload=l=>{if(l.target===null||typeof l.target.result!="string")return;let D=[];try{D=JSON.parse(l.target.result)}catch(h){console.error(h);return}B(1,D).catch(h=>console.error(h))},m.readAsText(d.item(0))}),i(),e.style.display=""};Y.register();document.addEventListener("DOMContentLoaded",()=>{je()});})();
